---
layout: post
title: "关于 OpenWrt IPv6 配置的那些坑"
categories: [ "技术", "OpenWrt" ]
date: 2021-08-26 15:03:12
---

大概调整了一个多周，博主家的网络布局终于稳定了下来，特此总结一下 OpenWrt 的 IPv6 配置中那些坑。

### 尽可能使用路由器拨号

OpenWrt 对于 IPv6 的支持貌似只对自己拨号有用，用光猫拨号我只在很新的 ImmortalWRT (OpenWrt 的一个第三方分支) 中配置成功过，即通过更改 DHCP 配置用 odhcpd 直接转发所有 IPv6 流量让光猫处理（即 IPv6 中继，参考[这篇文章](http://blog.kompaz.win/2017/02/22/OpenWRT%20IPv6%20%E9%85%8D%E7%BD%AE/)），但这种方式需要每次开机后都重启 odhcpd 才会生效，而且在不使用 odhcpd 的固件上根本没用。

路由器拨号对于中国联通的网络貌似还有一个好处，博主家的网络是联通的 200M 家宽，光猫拨号网速稳稳地超不过 200Mbps (关于数据传输速率的不同单位请自行百科) ，但换用 OpenWrt 拨号之后下行速率最高可以达到 263Mbps ，很难不怀疑联通的光猫在中间偷偷做了什么事。

下面的几个坑均为路由器拨号情况。（不要认为光猫拨号的坑会少，不仅不会少，还会更多）

### 有多个子网时的 IPv6 前缀长度

设置了多个子网时，我们往往需要在接口设置里添加多个静态地址接口（比如同时有 lan, lan2 两个接口），这时这几个接口设置中的“IPv6 分配长度”必须要大于 WAN 下发的 IPv6 前缀长度的值（比如 WAN 下发的 IPv6 前缀长度是 60 ，这里就需要设置 62 或更大），否则会导致其中一个接口占用了全部的分配范围而另一个接口分配不到 IPv6 地址的情况。

关于 WAN 下发的 IPv6 前缀长度可以在 状态 > 概况 > 网络 一节中找到（即“IPv6 WAN 状态”中的“分发前缀”中“/”后面的那个数字）

### 固件上一些自动设置的值

#### 网络 > 接口 > 全局网络选项

这里有一个“IPv6 ULA 前缀”，如果有一个自动设置的值，建议清空它。这个值可以用于 IPv6 NAT 方式的内网地址分配，但如果不使用 NAT 方式（一般不会使用，除非你有华为/荣耀的路由器，它们用了华为弱智工程师开发的弱智固件），它会干扰 IPv6 的原生地址分配，甚至直接让路由器不分配原生地址。

#### 网络 > DHCP/DNS > 服务器设置 > 高级设置

在较旧版本的固件上，“禁止解析 IPv6 DNS 记录”这一项一般默认是启用的，如果想舒舒服服用 IPv6 就一定要关掉它，不然只能成天背那些非常难记的 IPv6 地址了（启用这一项设置会阻断域名 IPv6 记录的查询）。


